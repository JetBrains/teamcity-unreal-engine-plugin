# TeamCity Unreal Engine plugin

[![official JetBrains project](http://jb.gg/badges/official.svg)](https://confluence.jetbrains.com/display/ALL/JetBrains+on+GitHub)
[![License](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https://opensource.org/licenses/Apache-2.0)

This plugin allows you to build Unreal Engine projects in TeamCity.

## Features

* Automatically detect Unreal Engine installed on build agents
* Dedicated runner that covers the most common use cases:
    * Execute the `BuildCookRun` command to perform all stages of the build process.
    * Utilize custom BuildGraph scripts (see the related [section](#build-graph)).
    * Launch automation tests.
* Automation test reporting

## Installation

You can download the plugin from the [marketplace][marketplace.plugin-page]. Installation instructions are available
[here][plugin-installation-guide].

## Detect Unreal Engine Installations

The plugin looks for the following files and directories on build agent machines to detect existing Unreal Engine installations (both installed from the Epic Games Launcher and built from the source code):

* The `LauncherInstalled.dat` file. Typically located at:
  * Windows — `{ProgramData}\Epic\UnrealEngineLauncher\​`
  * MacOS — `{home}/Library/Application Support/Epic/UnrealEngineLauncher/`
  * Linux — `{home}/.config/Epic/UnrealEngineLauncher/`
* The `Install.ini` file. Typically located at:
  * Linux — `{home}/.config/Epic/UnrealEngine/`
  * MacOS — `{home}/Library/Application Support/Epic/UnrealEngine/`
* The `SOFTWARE\Epic Games\Unreal Engine\Builds` registry key (Windows)

Once an engine is detected, its identifier and path are written to corresponding agent properties.
TeamCity utilizes these properties to match compatible agents with build configurations that manage UE solutions.

## Build Graph
The plugin supports two build graph execution models:
* Single machine
* Distributed

When in distributed mode, your build will be split across all of the available agents based on the description in your
[BuildGraph XML file][unreal-engine.build-graph-script-elements]: every agent will become a separate build configuration, and each node will become a build step.

Currently, there are a few settings that you should be aware of:
* Agent types are converted into the agent requirements, and you're free to mark your agents however you like.

    For example, suppose your agent definition in the build graph XML looks like this
    ``` xml
    <Agent Name="Do something dope" Type="Foo;Bar">
        ...
    <Agent>
    ```

    So, in order to make an agent eligible to run this build you should mark it via declaring [custom agent
configuration parameter][agent.configuration] with the name `unreal-engine.build-graph.agent.type`.
It might look like this
    ```properties
    unreal-engine.build-graph.agent.type = Foo
    ```
  or you could list as many types as you want like this
    ```properties
    unreal-engine.build-graph.agent.type = Foo;Bar;Baz
    ```
  As long as the agent has at least one matching type it will be eligible to run the build.
* When distributing a build it usually makes sense to set up a proper shared storage. Currently,
  you have to specify network share in the similar fashion via declaring another agent property with the name
  `unreal-engine.build-graph.agent.shared-dir` for each of the agents participating in a build process.

### How does that work

As mentioned earlier, when in distributed mode, the build graph will be converted from one representation
(Epic's JSON file, generated by running the BuildGraph command with the -Export parameter) to another (TeamCity's build chain).
Snapshot dependencies within the chain will be configured based on how you set them up between nodes in the graph.
It's worth mentioning that the resulting build configurations will include all the dependencies of their respective nodes.

It's better to demonstrate with an example. Suppose we have the following part of the BuildGraph description (unimportant details are omitted):
```xml
<Agent Name="Work A">
    <Node Name="Step A.1">
        ...
    </Node>
    <Node Name="Step A.2">
        ...
    </Node>
</Agent>
<Agent Name="Work B">
    <Node Name="Step B.1" Requires="Step A.1">
        ...
    </Node>
</Agent>
```
This will result in 2 build configurations:
* Work A
  * Step A.1
  * Step A.2
* Work B
  * Step B.1

The build configuration "Work B" will depend on a build configuration "Work A" despite the fact it might already have been
run after completing step "Step A.1". This is due to the nature of snapshot dependencies and the limitation in TeamCity
where triggering another build after completing a build step is impossible. Keep that in mind when writing your scripts.

## How to Contribute

We place a high value on user feedback and encourage you to share your experience and suggestions. Send a Pull Request to contribute or contact us via [YouTrack][youtrack] to report an issue.

## Development

### Prerequisites

* Docker
* Amazon JDK 11

### Building

1. Clone the repo
2. Setup local git hooks
    ```shell
    git config core.hooksPath .githooks
    ```
3. Build the project using Gradle
    ```shell
    ./gradlew build
    ```

## Additional Resources

- [Changelog](CHANGELOG.md)
- [Maintainership](MAINTAINERSHIP.md)

[youtrack]: https://youtrack.jetbrains.com/newIssue?project=TW&c=add%20Board%20TeamCity%20BTI%20%7C%20TeamCity%20Releases&c=add%20Board%20TeamCity%20Documentation%20No%20Fix%20versions&c=add%20Board%20TeamCity%20BTI&c=Team%20Build%20Tools%20Integrations&c=tag%20tc-unreal-engine
[marketplace.plugin-page]: https://TODO
[plugin-installation-guide]: https://www.jetbrains.com/help/teamcity/installing-additional-plugins.html
[agent.configuration]: https://www.jetbrains.com/help/teamcity/configure-agent-installation.html
[unreal-engine.build-graph-script-elements]: https://docs.unrealengine.com/5.3/en-US/buildgraph-script-elements-reference-for-unreal-engine/
